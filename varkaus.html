<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSL Jättöpaikkalaskuri</title>
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #11151a;
      --muted: #8a98a8;
      --text: #e6edf3;
      --accent: #4da3ff;
      --border: #1e252e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 32px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    h1 { margin: 0 0 12px; font-size: 28px; }
    p { color: var(--muted); margin-top: 6px; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }

    #drop-zone {
      flex: 1 1 320px;
      border: 2px dashed var(--border);
      background: var(--panel);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      color: var(--muted);
      transition: border-color .15s ease, background .15s ease;
    }
    #drop-zone.dragover { border-color: var(--accent); background: #0f1420; }

    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    button, .btn {
      border: 1px solid var(--border);
      background: #151b22;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    .btn-accent { border-color: #2b5fb5; background: #0e1a2e; }
    .chip { display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted) }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; background: var(--panel); border-radius: 14px; overflow: hidden; }
    thead th {
      text-align: left;
      font-size: 14px;
      letter-spacing: .02em;
      color: var(--muted);
      background: #0f1318;
      position: sticky; top: 0; z-index: 1;
    }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    tbody tr:hover { background: #0f1420; }
    tfoot td { font-weight: 700; }
    .right { text-align: right; }

    .note { font-size: 13px; color: var(--muted); margin-top: 8px; }
    .hidden { display:none; }
      /* Navigaatio */
    nav.site-nav { margin: 8px 0 18px; display: inline-flex; gap: 8px; flex-wrap: wrap; }
    .site-nav a { display:inline-block; padding:8px 12px; border:1px solid var(--border); border-radius:999px; text-decoration:none; color: var(--text); background:#151b22; font-weight:600; font-size:14px; }
    .site-nav a.active { border-color:#2b5fb5; background:#0e1a2e; }
  </style>
</head>
<body>
  <h1>TSL Jättöpaikkalaskuri</h1>
  <nav class="site-nav" aria-label="Sivuston navigaatio">
    <a class="nav-link" href="index.html">Lahti</a>
    <a class="nav-link" href="kouvola.html">Kouvola</a>
    <a class="nav-link active" href="varkaus.html">Varkaus</a>
  </nav>
  <p>Toimii seuraavilla lehdillä: Tämä täysin varalla. Tarkistetaan onko tarvetta, vai toimiiko täysin samoin kuin Kouvolan sivu.</p>

  <div class="row" style="margin: 12px 0 16px">
    <div id="drop-zone">
      <div style="font-size:16px; font-weight:700;">Pudota .TSL -tiedostot tähän</div>
      <div class="note" style="margin-top:6px">tai</div>
      <div style="margin-top:16px"><label class="btn btn-accent" for="file-input">Valitse tiedostot</label></div>
      <input id="file-input" class="hidden" type="file" accept=".tsl,.TSL" multiple />
      <div class="note" style="margin-top:12px"><span class="chip" id="file-count">Ei valittuja tiedostoja</span></div>
    </div>

    <div style="flex: 1 1 280px; min-width:280px">
      <div class="controls">
        <button id="btn-clear">Tyhjennä</button>
      </div>
      <div class="note" id="status" style="margin-top:10px"></div>
    </div>
  </div>

  <div id="table-wrap" class="hidden">
    <table id="results-table" aria-label="Tulostaulukko">
      <thead>
        <tr>
          <th style="width:28%">Jättöpaikka</th>
          <th class="right" style="width:10%">Kpl</th>
          <th style="width:14%">Osoitteellinen</th>
          <th class="right" style="width:12%">Piirien määrä jättöpaikalla</th>
          <th class="right" style="width:9%">100 nipuilla</th>
          <th class="right" style="width:9%">60 nipuilla</th>
          <th class="right" style="width:9%">50 kpl nipuilla</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td>YHTEENSÄ</td>
          <td class="right" id="total-kpl">0</td>
          <td></td>
          <td class="right" id="total-piirit">0</td>
          <td class="right"></td>
          <td class="right"></td>
          <td class="right"></td>
        </tr>
        <tr>
          <td>VARHAISJAKELU YHTEENSÄ</td>
          <td class="right" id="early-kpl">0</td>
          <td></td>
          <td class="right" id="early-piirit">0</td>
          <td class="right" id="early-b100">0</td>
          <td class="right" id="early-b60">0</td>
          <td class="right" id="early-b50">0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    // Merkitse aktiivinen välilehti URLin perusteella
    (function(){
      try{
        var path = (location.pathname || '').split('/').pop() || 'index.html';
        var links = document.querySelectorAll('.site-nav .nav-link');
        links.forEach(function(a){
          var href = a.getAttribute('href');
          if (href === path || (path === '' && href === 'index.html')) { a.classList.add('active'); }
        });
      } catch(e){}
    })();
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileCount = document.getElementById('file-count');
    const btnClear = document.getElementById('btn-clear');
    const status = document.getElementById('status');

    const tblWrap = document.getElementById('table-wrap');
    const tbody = document.querySelector('#results-table tbody');

    // Footer-solut
    const totalKplEl = document.getElementById('total-kpl');
    const totalPiiritEl = document.getElementById('total-piirit');
    const earlyKplEl = document.getElementById('early-kpl');
    const earlyPiiritEl = document.getElementById('early-piirit');
    const earlyB100El = document.getElementById('early-b100');
    const earlyB60El = document.getElementById('early-b60');
    const earlyB50El = document.getElementById('early-b50');

    // Drag & drop visuaaliset efektit
    ['dragenter','dragover'].forEach(evt => dropZone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add('dragover');
    }));
    ;['dragleave','drop'].forEach(evt => dropZone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove('dragover');
    }));

    dropZone.addEventListener('drop', async (e) => {
      const files = [...e.dataTransfer.files].filter(f => f.name.toLowerCase().endsWith('.tsl'));
      if (!files.length) { alert('Lataa vain .TSL -tiedostoja.'); return; }
      await handleFiles(files);
    });

    fileInput.addEventListener('change', async (e) => {
      const files = [...e.target.files].filter(f => f.name.toLowerCase().endsWith('.tsl'));
      if (!files.length) { alert('Valitse .TSL -tiedostoja.'); return; }
      await handleFiles(files);
    });

    btnClear.addEventListener('click', () => {
      tbody.innerHTML = '';
      tblWrap.classList.add('hidden');
      fileCount.textContent = 'Ei valittuja tiedostoja';
      status.textContent = '';
    });

    async function handleFiles(files) {
      fileCount.textContent = files.length + ' tiedosto' + (files.length === 1 ? '' : 'a');

      // Yhdistetty tulos useista tiedostoista
      const resultMap = Object.create(null);       // { key: kpl-summa } (key = Jättöpaikka tai 'POSTI')
      const addressType = Object.create(null);     // { key: true/false }
      const piiritLines = Object.create(null);     // { key: count of %2414 occurrences }
      const order = [];                            // ensimmäisen esiintymän järjestys (sis. 'POSTI' jos tarvitaan)

      for (const file of files) {
        const text = await readFileAsText(file);
        parseTSL(text, { resultMap, addressType, piiritLines, order });
      }

      renderResults({ resultMap, addressType, piiritLines, order });
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        // Monet TSL:t ovat Latin-1 (ISO-8859-1); käytetään sitä oletuksena
        reader.readAsText(file, 'ISO-8859-1');
        reader.onerror = reject;
      });
    }

    // Parseri:
    // - %2414 -rivi sisältää jättöpaikan nimen kohdissa [182,212)
    //   -> jokainen tällainen rivi kasvattaa kyseisen jättöpaikan "Piirien määrä jättöpaikalla" -laskuria +1
    // - edeltävä %2403 -rivi sisältää kappalemäärän kohdissa [22,26)
    // - %2405 heti jättöpaikan jälkeen tarkoittaa osoitteellista.
    // - LISÄYS: jos rivi on osoitteellinen, kaikki tällaiset rivit kootaan yhdeksi jättöpaikaksi nimeltä 'POSTI'.
    function parseTSL(text, ctx) {
      const { resultMap, addressType, piiritLines, order } = ctx;
      const lines = text.split(/\r?\n/);

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if (line.startsWith('%2414')) {
          const placeRaw = line.substring(182, 212);
          const place = (placeRaw || '').trim();
          if (!place) continue;

          // Onko osoitteellinen? Tarkistetaan seuraava rivi.
          const isAddressed = (i + 1 < lines.length && lines[i + 1].startsWith('%2405'));
          const key = isAddressed ? 'POSTI' : place;

          // Alustukset avaimelle (Jättöpaikka tai POSTI)
          if (!(key in resultMap)) {
            resultMap[key] = 0;
            addressType[key] = isAddressed;
            piiritLines[key] = 0;
            order.push(key);
          }
          // Jos POSTI on jo olemassa mutta tällä rivilläkin on osoitteellinen, varmista flagi
          if (isAddressed) addressType[key] = true;

          // Jokainen %2414 kasvattaa laskuria tälle avaimelle
          piiritLines[key] += 1;

          // Kpl poimitaan edelliseltä %2403 -riviltä ja lisätään tälle avaimelle
          if (i > 0 && lines[i - 1].startsWith('%2403')) {
            const qtyStr = lines[i - 1].substring(22, 26).trim();
            const qty = parseInt(qtyStr, 10) || 0;
            resultMap[key] += qty;
          }
        }
      }
    }

    function bundles(total, size) {
      if (!Number.isFinite(total) || total <= 0) return 0;
      return Math.ceil(total / size);
    }

    function renderResults({ resultMap, addressType, piiritLines, order }) {
      // Tyhjennä vanha
      tbody.innerHTML = '';

      let totalKpl = 0;
      let totalPiirit = 0;

      // Nämä summataan vain ei-POSTI -riveiltä
      let totalB100 = 0;
      let totalB60 = 0;
      let totalB50 = 0;

      // POSTI-muuttujat, jotta voimme laskea Varhaisjakelu = kaikki muut paitsi POSTI
      let postiKpl = 0;
      let postiPiirit = 0;

      for (const key of order) {
        const kpl = resultMap[key] || 0;
        const isAddressed = !!addressType[key];
        const name = key; // jos POSTI, näytetään POSTI
        const piirit = piiritLines[key] || 0;

        const isPosti = name === 'POSTI';

        // Nippusarake jätetään tyhjäksi POSTI-rivillä
        const b100 = isPosti ? '' : bundles(kpl, 100).toLocaleString('fi-FI');
        const b60  = isPosti ? '' : bundles(kpl, 60).toLocaleString('fi-FI');
        const b50  = isPosti ? '' : bundles(kpl, 50).toLocaleString('fi-FI');

        totalKpl += kpl;
        totalPiirit += piirit;

        if (isPosti) {
          postiKpl += kpl;
          postiPiirit += piirit;
        } else {
          totalB100 += bundles(kpl, 100);
          totalB60  += bundles(kpl, 60);
          totalB50  += bundles(kpl, 50);
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(name)}</td>
          <td class="right">${kpl.toLocaleString('fi-FI')}</td>
          <td>${isAddressed ? 'OSOITTEELLINEN' : ''}</td>
          <td class="right">${piirit.toLocaleString('fi-FI')}</td>
          <td class="right">${b100}</td>
          <td class="right">${b60}</td>
          <td class="right">${b50}</td>
        `;
        tbody.appendChild(tr);
      }

      // Yhteensä (Kpl + Piirit), ei nippusarakkeita
      totalKplEl.textContent = totalKpl.toLocaleString('fi-FI');
      totalPiiritEl.textContent = totalPiirit.toLocaleString('fi-FI');

      // Varhaisjakelu yhteensä = kaikki paitsi POSTI; sekä nippusummat ilman POSTI:a
      const earlyKpl = totalKpl - postiKpl;
      const earlyPiirit = totalPiirit - postiPiirit;

      earlyKplEl.textContent = earlyKpl.toLocaleString('fi-FI');
      earlyPiiritEl.textContent = earlyPiirit.toLocaleString('fi-FI');
      earlyB100El.textContent = totalB100.toLocaleString('fi-FI');
      earlyB60El.textContent  = totalB60.toLocaleString('fi-FI');
      earlyB50El.textContent  = totalB50.toLocaleString('fi-FI');

      tblWrap.classList.remove('hidden');

      status.textContent = 'Rivejä: ' + totalPiirit.toLocaleString('fi-FI') + ' • Jättöpaikkoja: ' + order.length + ' • Yhteensä ' + totalKpl.toLocaleString('fi-FI') + ' kpl';
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }
  </script>
</body>
</html>